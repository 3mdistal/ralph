import { $ } from "bun";
import { loadConfig, getRepoPath, getRepoBotBranch } from "./config";
import { ensureGhTokenEnv } from "./github-app-auth";
import { notifyRollupReady, notifyError } from "./notify";

type ClosingIssueOptions = {
  today: string;
  botBranch: string;
  prs: string[];
  closingIssues: string[];
  generatedAt: string;
};

function splitRepoFullName(full: string): { owner: string; name: string } {
  const [owner, name] = full.split("/");
  if (!owner || !name) {
    throw new Error(`Invalid repo name (expected owner/name): ${full}`);
  }
  return { owner, name };
}

function extractPullRequestNumber(url: string): number | null {
  const match = url.match(/\/pull\/(\d+)(?:$|\b|\/)/);
  if (!match) return null;
  return Number.parseInt(match[1], 10);
}

function extractClosingIssuesFromBody(body: string): string[] {
  const regex = /\b(?:fixes|closes|resolves)\s+#(\d+)\b/gi;
  const numbers = new Set<number>();
  let match: RegExpExecArray | null;
  while ((match = regex.exec(body)) !== null) {
    const issueNumber = Number.parseInt(match[1], 10);
    if (!Number.isNaN(issueNumber)) {
      numbers.add(issueNumber);
    }
  }
  return Array.from(numbers)
    .sort((a, b) => a - b)
    .map((value) => String(value));
}

function formatGhError(error: any): string {
  const message = String(error?.message ?? "").trim();
  const stderr = String(error?.stderr ?? "").trim();
  return [message, stderr].filter(Boolean).join("\n");
}

function buildRollupBody(options: ClosingIssueOptions): string {
  const prList = options.prs.map((pr) => `- ${pr}`).join("\n") || "- (none)";
  const lines: string[] = [
    `## Rollup: ${options.today} batch`,
    "",
    `This PR consolidates ${options.prs.length} changes from the \`${options.botBranch}\` branch.`,
    "",
    "### Included PRs",
    "",
    prList,
    "",
  ];

  if (options.closingIssues.length > 0) {
    lines.push("### Closes", "", ...options.closingIssues.map((issue) => `Fixes #${issue}`), "");
  }

  lines.push(
    "### Testing",
    "",
    "Please test the following areas affected by these changes:",
    "- Run the full test suite: `bun test`",
    "- Manually verify any UI changes",
    "- Check for regressions in core functionality",
    "",
    "### Review Notes",
    "",
    `This is an automated rollup created by Ralph Loop. Each individual PR was reviewed by @product and @devex agents before merging to \`${options.botBranch}\`.`,
    "",
    "---",
    `*Generated by Ralph Loop at ${options.generatedAt}*`
  );

  return lines.join("\n");
}

export function __extractClosingIssuesFromBodyForTests(body: string): string[] {
  return extractClosingIssuesFromBody(body);
}

export function __buildRollupBodyForTests(options: ClosingIssueOptions): string {
  return buildRollupBody(options);
}

export class RollupMonitor {
  private mergeCount: Map<string, number> = new Map();
  private mergedPRs: Map<string, string[]> = new Map();
  private batchSize: number;
  
  constructor(batchSize?: number) {
    this.batchSize = batchSize ?? loadConfig().batchSize;
  }
  
  /**
   * Record a successful merge to bot/integration
   */
  async recordMerge(repo: string, prUrl: string): Promise<void> {
    const count = (this.mergeCount.get(repo) || 0) + 1;
    this.mergeCount.set(repo, count);
    
    const prs = this.mergedPRs.get(repo) || [];
    prs.push(prUrl);
    this.mergedPRs.set(repo, prs);
    
    console.log(`[ralph:rollup] Recorded merge for ${repo}: ${prUrl} (${count}/${this.batchSize})`);
    
    if (count >= this.batchSize) {
      await this.createRollupPR(repo);
    }
  }
  
  /**
   * Create a rollup PR from bot/integration to main
   */
  async createRollupPR(repo: string): Promise<string | null> {
    const repoPath = getRepoPath(repo);
    const botBranch = getRepoBotBranch(repo);
    const prs = this.mergedPRs.get(repo) || [];

    console.log(`[ralph:rollup] Creating rollup PR for ${repo}...`);

    try {
      const today = new Date().toISOString().split("T")[0];
      const generatedAt = new Date().toISOString();
      const closingIssues = await this.collectClosingIssues(repo, prs);

      const body = buildRollupBody({
        today,
        botBranch,
        prs,
        closingIssues,
        generatedAt,
      });

      await ensureGhTokenEnv();
      const result = await $`gh pr create --repo ${repo} --base main --head ${botBranch} --title "Rollup: ${today} batch (${prs.length} PRs)" --body ${body}`
        .cwd(repoPath)
        .quiet();

      const prUrl = result.stdout.toString().trim();
      console.log(`[ralph:rollup] Created rollup PR: ${prUrl}`);

      this.mergeCount.set(repo, 0);
      this.mergedPRs.set(repo, []);

      await notifyRollupReady(repo, prUrl, prs);

      return prUrl;

    } catch (e: any) {
      console.error(`[ralph:rollup] Failed to create rollup PR:`, e);
      await notifyError(`Creating rollup PR for ${repo}`, e.message);
      return null;
    }
  }
  
  /**
   * Force a rollup for a specific repo (manual trigger)
   */
  async forceRollup(repo: string): Promise<string | null> {
    const count = this.mergeCount.get(repo) || 0;
    if (count === 0) {
      console.log(`[ralph:rollup] No merges to roll up for ${repo}`);
      return null;
    }
    
    return this.createRollupPR(repo);
  }
  
  /**
   * Get current status
   */
  getStatus(): Map<string, { count: number; prs: string[] }> {
    const status = new Map<string, { count: number; prs: string[] }>();

    for (const [repo, count] of this.mergeCount) {
      status.set(repo, {
        count,
        prs: this.mergedPRs.get(repo) || [],
      });
    }

    return status;
  }

  private async collectClosingIssues(repo: string, prs: string[]): Promise<string[]> {
    await ensureGhTokenEnv();
    const { owner, name } = splitRepoFullName(repo);
    const issues = new Set<string>();

    for (const prUrl of prs) {
      const prNumber = extractPullRequestNumber(prUrl);
      if (!prNumber) continue;

      try {
        const query = [
          "query($owner:String!,$name:String!,$number:Int!){",
          "repository(owner:$owner,name:$name){",
          "pullRequest(number:$number){",
          "body",
          "}",
          "}",
          "}",
        ].join(" ");

        const result = await $`gh api graphql -f query=${query} -f owner=${owner} -f name=${name} -F number=${prNumber}`.quiet();
        const parsed = JSON.parse(result.stdout.toString());
        const body = String(parsed?.data?.repository?.pullRequest?.body ?? "");

        for (const issue of extractClosingIssuesFromBody(body)) {
          issues.add(issue);
        }
      } catch (error: any) {
        console.warn(`[ralph:rollup] Could not fetch PR body for ${prUrl}: ${formatGhError(error)}`);
      }
    }

    return Array.from(issues).sort((a, b) => Number.parseInt(a, 10) - Number.parseInt(b, 10));
  }
}
