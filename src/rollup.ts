import { $ } from "bun";
import { loadConfig, getRepoPath, getRepoBotBranch } from "./config";
import { ensureGhTokenEnv } from "./github-app-auth";
import { notifyRollupReady, notifyError } from "./notify";

export class RollupMonitor {
  private mergeCount: Map<string, number> = new Map();
  private mergedPRs: Map<string, string[]> = new Map();
  private batchSize: number;
  
  constructor(batchSize?: number) {
    this.batchSize = batchSize ?? loadConfig().batchSize;
  }
  
  /**
   * Record a successful merge to bot/integration
   */
  async recordMerge(repo: string, prUrl: string): Promise<void> {
    const count = (this.mergeCount.get(repo) || 0) + 1;
    this.mergeCount.set(repo, count);
    
    const prs = this.mergedPRs.get(repo) || [];
    prs.push(prUrl);
    this.mergedPRs.set(repo, prs);
    
    console.log(`[ralph:rollup] Recorded merge for ${repo}: ${prUrl} (${count}/${this.batchSize})`);
    
    if (count >= this.batchSize) {
      await this.createRollupPR(repo);
    }
  }
  
  /**
   * Create a rollup PR from bot/integration to main
   */
  async createRollupPR(repo: string): Promise<string | null> {
    const repoPath = getRepoPath(repo);
    const botBranch = getRepoBotBranch(repo);
    const prs = this.mergedPRs.get(repo) || [];
    
    console.log(`[ralph:rollup] Creating rollup PR for ${repo}...`);
    
    try {
      // Build PR body
      const today = new Date().toISOString().split("T")[0];
      const prList = prs.map(pr => `- ${pr}`).join("\n");
      
      const body = `## Rollup: ${today} batch

This PR consolidates ${prs.length} changes from the \`${botBranch}\` branch.

### Included PRs

${prList}

### Testing

Please test the following areas affected by these changes:
- Run the full test suite: \`bun test\`
- Manually verify any UI changes
- Check for regressions in core functionality

### Review Notes

This is an automated rollup created by Ralph Loop. Each individual PR was reviewed by @product and @devex agents before merging to \`${botBranch}\`.

---
*Generated by Ralph Loop at ${new Date().toISOString()}*`;
      
      // Create the PR
      await ensureGhTokenEnv();
      const result = await $`gh pr create --repo ${repo} --base main --head ${botBranch} --title "Rollup: ${today} batch (${prs.length} PRs)" --body ${body}`.cwd(repoPath).quiet();
      
      const prUrl = result.stdout.toString().trim();
      console.log(`[ralph:rollup] Created rollup PR: ${prUrl}`);
      
      // Reset counts
      this.mergeCount.set(repo, 0);
      this.mergedPRs.set(repo, []);
      
      // Notify
      await notifyRollupReady(repo, prUrl, prs);
      
      return prUrl;
      
    } catch (e: any) {
      console.error(`[ralph:rollup] Failed to create rollup PR:`, e);
      await notifyError(`Creating rollup PR for ${repo}`, e.message);
      return null;
    }
  }
  
  /**
   * Force a rollup for a specific repo (manual trigger)
   */
  async forceRollup(repo: string): Promise<string | null> {
    const count = this.mergeCount.get(repo) || 0;
    if (count === 0) {
      console.log(`[ralph:rollup] No merges to roll up for ${repo}`);
      return null;
    }
    
    return this.createRollupPR(repo);
  }
  
  /**
   * Get current status
   */
  getStatus(): Map<string, { count: number; prs: string[] }> {
    const status = new Map<string, { count: number; prs: string[] }>();
    
    for (const [repo, count] of this.mergeCount) {
      status.set(repo, {
        count,
        prs: this.mergedPRs.get(repo) || [],
      });
    }
    
    return status;
  }
}
